<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<ProxyEndpoint name="v2_user_login">
    <PreFlow>
        <Request>
            <Step>
                <Name>assign_handle_cookies_accept</Name>
            </Step>
            <Step>
                <Condition>!(local_accept := "application/json")</Condition>
                <Name>fault_accept_json_not_found</Name>
            </Step>
            <Step>
                <Name>extract_refresh_token_params</Name>
                <Condition>request.content ~~ "^\{.+\}$"</Condition>
            </Step>
        </Request>
    </PreFlow>
    <Flows>
        <Flow name="refresh_token">
            <Request>
                <Step>
                    <Name>assign_set_local_header_variables</Name>
                </Step>
                <Step>
                    <Name>assign_set_local_query_variables</Name>
                </Step>
                <Step>
                    <Name>verify_apikey_clientid</Name>
                </Step>
                <Step>
                    <Condition>(verifyapikey.verify_apikey_clientid.client_secret != local_secret)</Condition>
                    <Name>fault_invalid_secret</Name>
                </Step>
                #common_spike_arrest_flow#
                <Step>
                    <Name>js_set_oauth_cred</Name>
                </Step>
                <Step>
                    <Name>oauthv2_refresh_accesstoken</Name>
                </Step>
                <Step>
                    <Name>assign_refresh_token_json_response</Name>
                </Step>
                #common_logging_post_flow#
            </Request>
            <Condition>local_granttype:="refresh_token"</Condition>
        </Flow>
        <Flow name="v2_user_login">
            <Request>
                <Step>
                    <Name>assign_set_user_login_target</Name>
                </Step>
                <Step>
                    <Name>assign_set_profile_v2_version</Name>
                </Step>
            </Request>
        </Flow>
    </Flows>
    <HTTPProxyConnection>
        <BasePath>/nsl/v2.0/user/login</BasePath>
        <VirtualHost>https_vhost</VirtualHost>
    </HTTPProxyConnection>
    <RouteRule name="deadend">
        <Condition>local_granttype:="refresh_token"</Condition>
    </RouteRule>
    <RouteRule name="login">
        <TargetEndpoint>register_or_login</TargetEndpoint>
    </RouteRule>
</ProxyEndpoint>
